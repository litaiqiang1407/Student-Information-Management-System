@page "/addedit/{Mode}/{Id?}"
@layout SIMS.Shared.Layouts.MainLayout
@using Microsoft.AspNetCore.Components.Forms
@inject SIMS.Shared.Functions.DatabaseInteractionFunctions DatabaseFunctions
@inject IWebHostEnvironment env
@inject HttpClient Http
@using Newtonsoft.Json
@using System.Text
@using System.Net

<div class="bordered-container">
    <div class="container">
        <div class="upload-photo">
            <label class="photo-icon">
                <img id="photo-preview" src="@photoUrl" alt="Preview" style="@(string.IsNullOrEmpty(photoUrl) ? "display:none;" : "display:block;")" />
                <i class="bi bi-camera"></i>
                <InputFile id="photo-upload" accept="image/*" OnChange="HandleFileSelected" style="opacity: 0; position: absolute; width: 100%; height: 100%; cursor: pointer;" />
            </label>
            <p>Upload Photo</p>
        </div>
        <div class="form-group">
            <div class="input-container">
                <label for="member-code">Member Code</label>
                <input type="text" id="member-code" placeholder="Enter member code..." class="input-field" @bind="MemberCode" />
            </div>
            <div class="input-container">
                <label for="email">Email</label>
                <input type="email" id="email" placeholder="Enter email..." class="input-field" @bind="Email" />
            </div>
        </div>
        <div class="form-group">
            <div class="input-container">
                <label for="name">Name</label>
                <input type="text" id="name" placeholder="Enter name..." class="input-field" @bind="Name" />
            </div>
            <div class="input-container">
                <label for="role">Role</label>
                <select id="role" class="input-field" @bind="Role">
                    <option value="" disabled selected>Choose a role...</option>
                    <option value="Student">Student</option>
                    <option value="Admin">Admin</option>
                    <option value="Lecture">Lecture</option>
                </select>
            </div>
        </div>
        <button class="btn btn-primary custom-button" @onclick="HandleSubmit">@ButtonText</button>
    </div>
</div>

@if (!string.IsNullOrEmpty(NotificationMessage))
{
    <ToastComponent Message="@NotificationMessage" IsSuccess="@NotificationSuccess" />
}

@code {
    [Parameter]
    public string Mode { get; set; }

    [Parameter]
    public string Id { get; set; }

    private string ButtonText => Mode == "add" ? "ADD" : "UPDATE";
    private string photoUrl;
    private string filePath;

    private string MemberCode { get; set; }
    private string Email { get; set; }
    private string Name { get; set; }
    private string Role { get; set; }

    private string NotificationMessage { get; set; }
    private bool NotificationSuccess { get; set; }
    private IBrowserFile selectedFile;

    private UserInfos userInfo;

    protected override async Task OnParametersSetAsync()
    {
        if (Mode == "edit" && !string.IsNullOrEmpty(Id))
        {
            // Load data for editing using Id
            await LoadItemAsync(Id);
        }
        else if (Mode == "add")
        {
            // Initialize the form for adding a new user
            ClearForm();
        }
    }

    private void ClearForm()
    {
        // Clear or reset form fields for adding a new user
        MemberCode = string.Empty;
        Email = string.Empty;
        Name = string.Empty;
        Role = string.Empty;
        photoUrl = null;
        selectedFile = null;
    }

    private async Task LoadItemAsync(string id)
    {
        try
        {
            // Call the API to get user details based on the provided Id
            userInfo = await DatabaseFunctions.LoadSingleData<UserInfos>($"api/Admin/UserInfos/{id}");

            if (userInfo != null)
            {
                // Assign the retrieved data to the form fields
                MemberCode = userInfo.MemberCode;
                Email = userInfo.Email;
                Name = userInfo.Name;
                Role = userInfo.RoleName; // Assuming RoleName is the role name; adjust if needed
                photoUrl = userInfo.OfficialAvatar; // Update the photo URL if necessary
            }
            else
            {
                // Notify the user if no data is found for the given Id
                NotificationMessage = "No data found for the given ID.";
                NotificationSuccess = false;
            }
        }
        catch (Exception ex)
        {
            // Handle any errors that occur during the API call
            NotificationMessage = $"Error occurred: {ex.Message}";
            NotificationSuccess = false;
        }
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;

        if (!IsValidImageFile(file))
        {
            photoUrl = null;
            selectedFile = null;
            return;
        }

        selectedFile = file;
        photoUrl = await ConvertToBase64Async(file);
        StateHasChanged();
    }

    private bool IsValidImageFile(IBrowserFile file)
    {
        return file != null && file.ContentType.StartsWith("image/") && file.Size <= 5 * 1024 * 1024; // File size limit of 5MB
    }

    private async Task<string> ConvertToBase64Async(IBrowserFile file)
    {
        using var stream = new MemoryStream();
        await file.OpenReadStream().CopyToAsync(stream);
        var buffer = stream.ToArray();
        return $"data:{file.ContentType};base64,{Convert.ToBase64String(buffer)}";
    }

    private async Task SaveFileAsync(IBrowserFile file)
    {
        var uploadsFolder = Path.Combine(env.WebRootPath, "Uploads");
        Directory.CreateDirectory(uploadsFolder);

        var uniqueFileName = $"{Guid.NewGuid()}_{file.Name}";
        filePath = Path.Combine(uploadsFolder, uniqueFileName);

        using var stream = new FileStream(filePath, FileMode.Create);
        await file.OpenReadStream().CopyToAsync(stream);

        filePath = Path.Combine("Uploads", uniqueFileName);
    }

    private async Task HandleSubmit()
    {
        // Check for missing required fields
        if (string.IsNullOrEmpty(Name) || string.IsNullOrEmpty(Role) || string.IsNullOrEmpty(Email) || string.IsNullOrEmpty(MemberCode))
        {
            NotificationMessage = "Please fill out all required fields.";
            NotificationSuccess = false;
            return;
        }

        // Default image path if no file is selected
        if (selectedFile != null)
        {
            await SaveFileAsync(selectedFile);
        }
        else
        {
            filePath = "https://cdn-icons-png.freepik.com/256/7666/7666584.png"; // Ensure this is a valid fallback image
        }

        var formData = new MultipartFormDataContent
        {
            { new StringContent(MemberCode), "memberCode" },
            { new StringContent(Email), "email" },
            { new StringContent(Name), "name" },
            { new StringContent(Role), "role" },
            { new StringContent(filePath), "imagePath" }
        };

        // Log the form data for debugging
        Console.WriteLine($"MemberCode: {MemberCode}, Email: {Email}, Name: {Name}, Role: {Role}, ImagePath: {filePath}");

        HttpResponseMessage result;

        try
        {
            if (Mode == "edit" && !string.IsNullOrEmpty(Id))
            {
                var updateEndpoint = $"https://localhost:7006/api/Admin/UpdateUserInfos/{Id}";
                result = await Http.PutAsync(updateEndpoint, formData);
            }
            else
            {
                var addEndpoint = "https://localhost:7006/api/Admin/AddAccount";
                result = await Http.PostAsync(addEndpoint, formData);
            }

            if (result.StatusCode == HttpStatusCode.NoContent)
            {
                NotificationMessage = "Operation successful!";
                NotificationSuccess = true;
            }
            else if (result.IsSuccessStatusCode)
            {
                var responseContent = await result.Content.ReadFromJsonAsync<ApiResponse>();
                NotificationMessage = responseContent.Message;
                NotificationSuccess = responseContent.Success;
            }
            else
            {
                var responseContent = await result.Content.ReadAsStringAsync();
                NotificationMessage = $"Failed to process request. Status code: {result.StatusCode}, Response: {responseContent}";
                NotificationSuccess = false;
            }
        }
        catch (Exception ex)
        {
            NotificationMessage = $"Exception occurred: {ex.Message}";
            NotificationSuccess = false;
        }
    }

    public class ApiResponse
    {
        public bool Success { get; set; }
        public string Message { get; set; }
    }
}
