@page "/addedit/{Mode}/{Id?}"
@layout SIMS.Shared.Layouts.MainLayout
@using Microsoft.AspNetCore.Components.Forms
@inject IWebHostEnvironment env
@inject HttpClient Http

<div class="bordered-container">
    <div class="container">
        <div class="upload-photo">
            <label class="photo-icon">
                <img id="photo-preview" src="@photoUrl" alt="Preview" style="@(string.IsNullOrEmpty(photoUrl) ? "display:none;" : "display:block;")" />
                <i class="bi bi-camera"></i>
                <InputFile id="photo-upload" accept="image/*" OnChange="HandleFileSelected" style="opacity: 0; position: absolute; width: 100%; height: 100%; cursor: pointer;" />
            </label>
            <p>Upload Photo</p>
        </div>
        <div class="form-group">
            <div class="input-container">
                <label for="member-code">Member Code</label>
                <input type="text" id="member-code" placeholder="Enter member code..." class="input-field" @bind="MemberCode" />
            </div>
            <div class="input-container">
                <label for="email">Email</label>
                <input type="email" id="email" placeholder="Enter email..." class="input-field" @bind="Email" />
            </div>
        </div>
        <div class="form-group">
            <div class="input-container">
                <label for="name">Name</label>
                <input type="text" id="name" placeholder="Enter name..." class="input-field" @bind="Name" />
            </div>
            <div class="input-container">
                <label for="role">Role</label>
                <select id="role" class="input-field" @bind="Role">
                    <option value="" disabled selected>Choose a role...</option>
                    <option value="Student">Student</option>
                    <option value="Admin">Admin</option>
                    <option value="Lecture">Lecture</option>
                </select>
            </div>
        </div>
        <button class="btn btn-primary custom-button" @onclick="HandleSubmit">@ButtonText</button>

        @if (!string.IsNullOrEmpty(NotificationMessage))
        {
            <div class="alert alert-@(NotificationSuccess ? "success" : "danger")" role="alert">
                @NotificationMessage
            </div>
        }
    </div>
</div>

@code {
    [Parameter]
    public string Mode { get; set; }

    [Parameter]
    public string Id { get; set; }

    private string ButtonText => Mode == "add" ? "ADD" : "UPDATE";
    private string photoUrl;
    private string filePath;

    private string MemberCode { get; set; }
    private string Email { get; set; }
    private string Name { get; set; }
    private string Role { get; set; }

    private string NotificationMessage { get; set; }
    private bool NotificationSuccess { get; set; }
    private IBrowserFile selectedFile;

    protected override async Task OnParametersSetAsync()
    {
        if (Mode == "edit" && !string.IsNullOrEmpty(Id))
        {
            // Load data for editing using Id
            await LoadItemAsync(Id);
        }
    }

    private async Task LoadItemAsync(string id)
    {
        // Implement logic to load item details based on Id
        // e.g., call a service to get item details and set properties
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;

        if (!IsValidImageFile(file))
        {
            photoUrl = null;
            selectedFile = null;
            return;
        }

        selectedFile = file;
        photoUrl = await ConvertToBase64Async(file);
        StateHasChanged();
    }

    private bool IsValidImageFile(IBrowserFile file)
    {
        return file != null && file.ContentType.StartsWith("image/") && file.Size <= 5 * 1024 * 1024; // File size limit of 5MB
    }

    private async Task<string> ConvertToBase64Async(IBrowserFile file)
    {
        using var stream = new MemoryStream();
        await file.OpenReadStream().CopyToAsync(stream);
        var buffer = stream.ToArray();
        return $"data:{file.ContentType};base64,{Convert.ToBase64String(buffer)}";
    }

    private async Task SaveFileAsync(IBrowserFile file)
    {
        var uploadsFolder = Path.Combine(env.WebRootPath, "Uploads");
        Directory.CreateDirectory(uploadsFolder);

        var uniqueFileName = $"{Guid.NewGuid()}_{file.Name}";
        filePath = Path.Combine(uploadsFolder, uniqueFileName);

        using var stream = new FileStream(filePath, FileMode.Create);
        await file.OpenReadStream().CopyToAsync(stream);

        filePath = Path.Combine("Uploads", uniqueFileName);
    }

    private async Task HandleSubmit()
    {
        if (string.IsNullOrEmpty(MemberCode) || string.IsNullOrEmpty(Email) || string.IsNullOrEmpty(Name) || string.IsNullOrEmpty(Role))
        {
            // Show an error message to the user
            NotificationMessage = "Please fill out all fields.";
            NotificationSuccess = false;
            return;
        }

        if (selectedFile != null)
        {
            await SaveFileAsync(selectedFile);
        }
        else
        {
            filePath = "https://cdn-icons-png.freepik.com/256/7666/7666584.png";
        }

        var content = new MultipartFormDataContent();
        content.Add(new StringContent(MemberCode), "memberCode");
        content.Add(new StringContent(Email), "email");
        content.Add(new StringContent(Name), "name");
        content.Add(new StringContent(Role), "role");
        content.Add(new StringContent(filePath), "imagePath");

        var result = await Http.PostAsync("https://localhost:7006/api/Admin/AddAccount", content);

        if (result.IsSuccessStatusCode)
        {
            var responseContent = await result.Content.ReadFromJsonAsync<ApiResponse>();
            NotificationMessage = responseContent.Message;
            NotificationSuccess = responseContent.Success;
        }
        else
        {
            NotificationMessage = "Failed to add account.";
            NotificationSuccess = false;
        }
    }


    public class ApiResponse
    {
        public bool Success { get; set; }
        public string Message { get; set; }
    }
}

